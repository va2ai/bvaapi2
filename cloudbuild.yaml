timeout: "1200s"

substitutions:
  _REGION: us-central1
  _REPO: bva-api
  _SERVICE: bva-api
  _MCP_SERVICE: bva-mcp

images:
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest'
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_MCP_SERVICE:latest'

steps:
  # Build and deploy BVA API (pass OPENAI_API_KEY for RAG index baking)
  - name: gcr.io/cloud-builders/docker
    entrypoint: bash
    args:
      - '-c'
      - |
        docker build --build-arg OPENAI_API_KEY=$$OPENAI_API_KEY \
          -t $_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest .
    secretEnv: ['OPENAI_API_KEY']
  - name: gcr.io/cloud-builders/docker
    args: ['push', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest']
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      [
        'run','deploy','$_SERVICE',
        '--image','$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest',
        '--region','$_REGION',
        '--allow-unauthenticated',
        '--set-secrets','OPENAI_API_KEY=OPENAI_API_KEY:latest'
      ]

  # Build and deploy BVA MCP server
  - name: gcr.io/cloud-builders/docker
    args: ['build', '-f', 'Dockerfile.mcp', '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_MCP_SERVICE:latest', '.']
  - name: gcr.io/cloud-builders/docker
    args: ['push', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_MCP_SERVICE:latest']
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      [
        'run','deploy','$_MCP_SERVICE',
        '--image','$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_MCP_SERVICE:latest',
        '--region','$_REGION',
        '--allow-unauthenticated'
      ]

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/OPENAI_API_KEY/versions/latest
      env: 'OPENAI_API_KEY'
